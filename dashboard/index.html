<!-- <!DOCTYPE html>
<html>
<head>
    <title>Shadow-Walk | Live Safety Navigation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

    <style>
        body { margin: 0; font-family: 'Segoe UI', Roboto, sans-serif; background: #0b0d11; overflow: hidden; }
        #map { height: 100vh; width: 100%; visibility: hidden; } /* Hidden until located */
        
        /* Loading Screen */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0b0d11; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999; color: white;
        }

        .travel-info {
            position: absolute; bottom: 0; left: 0; right: 0; 
            background: #1a1c23; color: white; padding: 20px;
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            z-index: 2000; display: none;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.5);
        }
        .info-row { display: flex; justify-content: space-between; align-items: center; }
        .time-text { color: #00ff88; font-size: 1.5rem; font-weight: bold; }
        .dist-text { color: #888; font-size: 1.1rem; }
        .safety-tag { background: rgba(0,255,136,0.1); color: #00ff88; padding: 4px 10px; border-radius: 5px; border: 1px solid #00ff88; }
        
        .leaflet-control-geocoder { border-radius: 12px !important; margin-top: 20px !important; }
    </style>
</head>
<body>

    <div id="loader">
        <div style="border: 4px solid #333; border-top: 4px solid #00ff88; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
        <p>Acquiring Precise GPS Lock...</p>
    </div>

    <div id="map"></div>

    <div class="travel-info" id="travel-panel">
        <div class="info-row">
            <div>
                <span class="time-text" id="time-left">-- min</span><br>
                <span class="dist-text" id="dist-left">-- km</span>
            </div>
            <div class="safety-tag" id="safety-status">üõ°Ô∏è SAFEST ROUTE ACTIVE</div>
            <button onclick="location.reload()" style="background:#333; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer;">Exit</button>
        </div>
    </div>

    <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>

    <script>
        const map = L.map('map', { zoomControl: false });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        let userLat, userLng, destinationLatLng;
        let routingControl = null;
        let userMarker = null;
        let hasInitialLock = false;

        // 1. Setup Geocoder
        L.Control.geocoder({ defaultMarkGeocode: false, placeholder: "Where to go safely?" })
            .on('markgeocode', e => {
                destinationLatLng = e.geocode.center;
                startNavigation();
            }).addTo(map);

        // 2. High Accuracy GPS Implementation
        function success(pos) {
            userLat = pos.coords.latitude;
            userLng = pos.coords.longitude;
            const currentPos = [userLat, userLng];

            if (!hasInitialLock) {
                // Remove loader and show map once real GPS is found
                document.getElementById('loader').style.display = 'none';
                document.getElementById('map').style.visibility = 'visible';
                map.setView(currentPos, 17);
                userMarker = L.circleMarker(currentPos, { radius: 9, color: '#fff', fillColor: '#007AFF', fillOpacity: 1 }).addTo(map);
                hasInitialLock = true;
            } else {
                userMarker.setLatLng(currentPos);
                if (routingControl) {
                    map.panTo(currentPos);
                    updateLiveStats();
                }
            }
        }

        function error(err) {
            console.warn(`ERROR(${err.code}): ${err.message}`);
            alert("Please enable High Accuracy GPS/Location services.");
        }

        // The "Secret Sauce": Continuous watch with absolute zero caching
        navigator.geolocation.watchPosition(success, error, {
            enableHighAccuracy: true, // Forces phone to use GPS satellites, not just WiFi
            timeout: 10000,
            maximumAge: 0 // Strictly no cached locations
        });

        // 3. Navigation & Dashboard Logic
        function startNavigation() {
            if (routingControl) map.removeControl(routingControl);
            document.getElementById('travel-panel').style.display = 'block';

            routingControl = L.Routing.control({
                waypoints: [L.latLng(userLat, userLng), L.latLng(destinationLatLng.lat, destinationLatLng.lng)],
                lineOptions: { styles: [{ color: '#00ff88', weight: 8, opacity: 0.8 }] },
                createMarker: () => null,
                addWaypoints: false,
                router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' })
            }).on('routesfound', e => {
                const routes = e.routes[0];
                document.getElementById('dist-left').innerText = (routes.summary.totalDistance / 1000).toFixed(1) + " km";
                document.getElementById('time-left').innerText = Math.round(routes.summary.totalTime / 60) + " min";
            }).addTo(map);
        }

        function updateLiveStats() {
            if (routingControl) {
                routingControl.spliceWaypoints(0, 1, L.latLng(userLat, userLng));
            }
        }

        // 4. Real-time Danger Updates
        const socket = io('http://localhost:3000');
        socket.on('new-danger-zone', data => {
            L.circle([data.lat, data.lng], { color: 'red', fillColor: '#f03', fillOpacity: 0.5, radius: 250 }).addTo(map);
            if (routingControl) {
                routingControl.options.lineOptions.styles = [{ color: '#ff3b30', weight: 8 }];
                document.getElementById('safety-status').innerText = "‚ö†Ô∏è DANGER ON ROUTE";
                document.getElementById('safety-status').style.color = "red";
            }
        });
    </script>
</body>
</html> -->

<!DOCTYPE html>
<html>
<head>
    <title>Shadow-Walk | High-Precision Navigation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #0b0d11; }
        #map { height: 100vh; width: 100%; visibility: hidden; } 
        
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0b0d11; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999; color: white;
            text-align: center; padding: 20px;
        }

        .travel-info {
            position: absolute; bottom: 0; left: 0; right: 0; 
            background: #1a1c23; color: white; padding: 20px;
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            z-index: 2000; display: none;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.5);
        }
        .info-row { display: flex; justify-content: space-between; align-items: center; }
        .time-text { color: #00ff88; font-size: 1.5rem; font-weight: bold; }
        .safety-tag { background: rgba(0,255,136,0.1); color: #00ff88; padding: 4px 10px; border-radius: 5px; border: 1px solid #00ff88; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader">
        <div style="border: 4px solid #333; border-top: 4px solid #00ff88; border-radius: 50%; width: 45px; height: 45px; animation: spin 1s linear infinite; margin-bottom: 15px;"></div>
        <p id="status-text">Waiting for Satellite Lock...<br><small style="color: #888;">Go near a window or step outside for best results.</small></p>
    </div>

    <div id="map"></div>

    <div class="travel-info" id="travel-panel">
        <div class="info-row">
            <div>
                <span class="time-text" id="time-left">-- min</span><br>
                <span style="color:#888" id="dist-left">-- km</span>
            </div>
            <div class="safety-tag" id="safety-status">üõ°Ô∏è PRECISION GPS ACTIVE</div>
            <button onclick="location.reload()" style="background:#444; color:white; border:none; padding:10px 15px; border-radius:8px;">Exit</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
        // Initialize Map
        const map = L.map('map', { zoomControl: false });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        let userLat, userLng, destinationLatLng;
        let routingControl = null;
        let userMarker = null;
        let accuracyCircle = null;

        // --- PRECISION GPS LOGIC ---

        function onLocationFound(pos) {
            const acc = pos.coords.accuracy;
            console.log(`Accuracy: ${acc} meters`);

            // Only show map if accuracy is better than 60 meters (WiFi/Cell fallback is usually >100m)
            if (acc > 60 && !userMarker) {
                document.getElementById('status-text').innerHTML = `Signal Weak (${Math.round(acc)}m)...<br>Seeking Satellites...`;
                return;
            }

            userLat = pos.coords.latitude;
            userLng = pos.coords.longitude;
            const currentPos = [userLat, userLng];

            // UI Updates
            document.getElementById('loader').style.display = 'none';
            document.getElementById('map').style.visibility = 'visible';

            if (!userMarker) {
                // First lock
                userMarker = L.circleMarker(currentPos, { 
                    radius: 8, color: '#fff', fillColor: '#007AFF', fillOpacity: 1, weight: 2 
                }).addTo(map);
                
                accuracyCircle = L.circle(currentPos, {
                    radius: acc, color: '#007AFF', weight: 1, fillOpacity: 0.1
                }).addTo(map);

                map.setView(currentPos, 18);
            } else {
                // Update movement
                userMarker.setLatLng(currentPos);
                accuracyCircle.setLatLng(currentPos);
                accuracyCircle.setRadius(acc);
            }

            if (routingControl) updateLiveStats();
        }

        function onLocationError(err) {
            alert("GPS Error: Please ensure Location is set to 'Always Allow' and 'High Accuracy' is ON.");
        }

        // FORCE HIGH ACCURACY
        navigator.geolocation.watchPosition(onLocationFound, onLocationError, {
            enableHighAccuracy: true, // Forces Hardware GPS
            timeout: 20000,           // 20 second wait for cold start
            maximumAge: 0             // No caching
        });

        // --- NAVIGATION ---

        L.Control.geocoder({ defaultMarkGeocode: false, placeholder: "Destination..." })
            .on('markgeocode', e => {
                destinationLatLng = e.geocode.center;
                startNavigation();
            }).addTo(map);

        function startNavigation() {
            if (routingControl) map.removeControl(routingControl);
            document.getElementById('travel-panel').style.display = 'block';

            routingControl = L.Routing.control({
                waypoints: [L.latLng(userLat, userLng), L.latLng(destinationLatLng.lat, destinationLatLng.lng)],
                lineOptions: { styles: [{ color: '#00ff88', weight: 7, opacity: 0.9 }] },
                createMarker: () => null,
                router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' })
            }).on('routesfound', e => {
                const r = e.routes[0];
                document.getElementById('dist-left').innerText = (r.summary.totalDistance / 1000).toFixed(2) + " km";
                document.getElementById('time-left').innerText = Math.round(r.summary.totalTime / 60) + " min";
            }).addTo(map);
        }

        function updateLiveStats() {
            routingControl.spliceWaypoints(0, 1, L.latLng(userLat, userLng));
        }

        // Backend Socket
        const socket = io('http://localhost:3000');
        socket.on('new-danger-zone', data => {
            L.circle([data.lat, data.lng], { color: 'red', radius: 150 }).addTo(map);
        });
    </script>
</body>
</html>