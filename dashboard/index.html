<!DOCTYPE html>
<html>
<head>
    <title>Shadow-Walk | Safest Route AI</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <style>
        body { margin: 0; background: #0b0e11; color: white; font-family: 'Segoe UI', sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; }

        .leaflet-control-geocoder {
            min-width: 350px !important; margin-top: 20px !important;
            background: #1c1f26 !important; border: 2px solid #00ff88 !important; border-radius: 8px !important;
        }
        .leaflet-control-geocoder-form input { background: transparent !important; color: white !important; padding: 10px !important; }
        
        .info-panel {
            position: absolute; bottom: 30px; left: 30px; z-index: 1000;
            background: rgba(28, 31, 38, 0.95); padding: 20px;
            border-radius: 12px; border: 1px solid #00ff88; min-width: 250px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
        }
        .safety-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-weight: bold; margin-top: 5px; }
        .safe { background: #00ff88; color: black; }
        .danger { background: #ff4444; color: white; }
    </style>
</head>
<body>

    <div class="info-panel">
        <h3 style="margin:0; color:#00ff88;">üõ°Ô∏è Safe-Path Monitor</h3>
        <p id="dist">Distance: -- km</p>
        <div id="safe-status" class="safety-badge safe">Analyzing Environment...</div>
        <p style="font-size: 0.8rem; color: #888; margin-top: 10px;">Scanning for: 24/7 Shops & SOS Reports</p>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>

        const map = L.map('map').setView([12.9716, 77.5946], 15);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        let userLocation = null;
        let userMarker = null;
        let firstFix = true;
        let routeControl = null;

        let activeSOS = [];              // live + historical
        let firebaseDangerZones = [];    // üî¥ Firebase-only danger zones

        /* ---------------- FIREBASE DANGER ZONES (ADDED) ---------------- */

        async function loadFirebaseDangerZones() {
            try {
                const res = await fetch(
                    "https://project-d0293720-354a-4177-a34-default-rtdb.asia-southeast1.firebasedatabase.app/sos-alerts.json"
                );
                const data = await res.json();
                if (!data) return;

                Object.values(data).forEach(d => {
                    if (!d.lat || !d.lng) return;

                    const point = L.latLng(d.lat, d.lng);
                    firebaseDangerZones.push(point);
                    activeSOS.push(point); // included in safety check

                    // Visual indicator (no UI logic changed)
                    L.circle(point, {
                        color: 'red',
                        radius: 300,
                        fillOpacity: 0.25
                    }).addTo(map)
                      .bindPopup("üö® Previous Danger Location");
                });

            } catch (e) {
                console.error("Failed to load Firebase danger zones", e);
            }
        }

        loadFirebaseDangerZones();

        /* ---------------- REAL-TIME SOS (UNCHANGED) ---------------- */

        const socket = io('http://localhost:3000');
        socket.on('new-alert', (data) => {
            if (data.type === "SOS") {
                const point = L.latLng(data.lat, data.lng);
                activeSOS.push(point);

                L.circle(point, {
                    color: 'red',
                    radius: 250,
                    fillOpacity: 0.4
                }).addTo(map)
                  .bindPopup("üö® Danger: Recent incident reported!");

                if (routeControl && routeControl._line) {
                    checkSafety(routeControl._line._latlngs);
                }
            }
        });

        /* ---------------- GEOLOCATION (UNCHANGED) ---------------- */

        map.locate({
            watch: true,
            setView: false,
            enableHighAccuracy: true,
            maximumAge: 1000,
            timeout: 10000
        });

        map.on('locationfound', (e) => {
            userLocation = e.latlng;

            const accuracy = e.accuracy || 50;

            if (window.accuracyCircle) map.removeLayer(window.accuracyCircle);
            window.accuracyCircle = L.circle(e.latlng, {
                radius: accuracy,
                color: '#4a90ff',
                fillColor: '#4a90ff',
                fillOpacity: 0.12,
                weight: 1
            }).addTo(map);

            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.circleMarker(e.latlng, {
                radius: 6,
                color: 'white',
                weight: 2,
                fillColor: '#2d7cff',
                fillOpacity: 1
            }).addTo(map);

            map.panTo(e.latlng, { animate: true, duration: 0.5 });

            if (firstFix) firstFix = false;
        });

        /* ---------------- SEARCH & ROUTE (UNCHANGED) ---------------- */

        const geocoder = L.Control.geocoder({ collapsed: false, placeholder: "Enter Destination..." })
            .on('markgeocode', (e) => calculateRoute(e.geocode.center))
            .addTo(map);

        function calculateRoute(dest) {
            if (!userLocation) {
                alert("üìç Waiting for your location...");
                return;
            }

            if (routeControl) map.removeControl(routeControl);
            
            routeControl = L.Routing.control({
                waypoints: [
                    L.latLng(userLocation.lat, userLocation.lng),
                    L.latLng(dest.lat, dest.lng)
                ],
                lineOptions: { styles: [{ color: '#00ff88', weight: 6, opacity: 0.8 }] },
                createMarker: () => null
            }).addTo(map);

            routeControl.on('routesfound', (e) => {
                const dist = (e.routes[0].summary.totalDistance / 1000).toFixed(2);
                document.getElementById('dist').innerText = `Distance: ${dist} km`;
                checkSafety(e.routes[0].coordinates);
            });
        }

        /* ---------------- SAFETY CHECK (MINIMAL ADDITION) ---------------- */

        function checkSafety(pathCoords) {
            let isDangerous = false;

            pathCoords.forEach(coord => {
                activeSOS.forEach(sos => {
                    if (L.latLng(coord.lat, coord.lng).distanceTo(sos) < 300) {
                        isDangerous = true;
                    }
                });
            });

            const status = document.getElementById('safe-status');
            if (isDangerous) {
                status.innerText = "‚ö†Ô∏è ROUTE DANGER DETECTED";
                status.className = "safety-badge danger";
            } else {
                status.innerText = "‚úÖ SAFEST PATH VERIFIED";
                status.className = "safety-badge safe";
            }
        }

    </script>
</body>
</html>
